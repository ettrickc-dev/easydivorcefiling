<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NY Uncontested Divorce â€” Free Test Mode</title>
<meta name="description" content="Instant Summons & Complaint for NY uncontested divorce. Test mode: all downloads are free (no PayPal)."/>

<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#fff;color:#111}
  .wrap{max-width:980px;margin:22px auto;padding:0 16px}
  h1{margin:8px 0 10px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .chip{border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:.92rem;background:#fff}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px 16px 18px;margin:14px 0;box-shadow:0 6px 16px rgba(0,0,0,.04)}
  label{display:block;margin:10px 0 6px;font-weight:600}
  input,select,textarea{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:8px;background:#f9fafb}
  .row{display:grid;gap:12px}
  @media(min-width:760px){.row-2{grid-template-columns:1fr 1fr}}
  .btn{display:inline-flex;gap:.5rem;align-items:center;justify-content:center;padding:12px 18px;border-radius:10px;border:0;background:#0d6efd;color:#fff;font-weight:700;cursor:pointer}
  .btn.alt{background:#16a34a}
  .note{font-size:.95rem;color:#374151}
  .hidden{display:none}
  .ok{color:#16a34a;font-weight:700}
  .grid2{display:grid;gap:10px}
  @media(min-width:880px){.grid2{grid-template-columns:1fr 1fr}}
  .guarantee{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:10px;margin-top:8px}
  .faq dt{font-weight:700;margin-top:10px}
  .faq dd{margin:4px 0 10px}
  .dev{background:#fff7ed;border:1px dashed #fdba74;border-radius:10px;padding:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>NY Uncontested Divorce (No Children)</h1>
  <div class="chips">
    <span class="chip">âœ… Court-Ready Formatting</span>
    <span class="chip">ðŸ”’ Secure PayPal (disabled for testing)</span>
    <span class="chip">ðŸ“¥ Instant Download</span>
    <span class="chip">ðŸ“§ Copy emailed to attorney</span>
  </div>

  <div class="card">
    <p class="note">Fill this out. Youâ€™ll get your <strong>Summons &amp; Complaint</strong> instantly for free. Then choose either (a) <strong>$199</strong> for the full DIY pack (all remaining forms + instructions), or (b) <strong>$999</strong> attorney-handled service (we file for you &amp; cover filing fees).</p>
    <div class="guarantee"><strong>Weâ€™ve got your back:</strong> If any $199 package document is rejected for a formatting issue, weâ€™ll fix it free.</div>
  </div>

  <form id="qform" class="card">
    <h3>Your Info</h3>

    <label>Email (for receipts & document delivery) *</label>
    <input id="email" type="email" required placeholder="you@example.com"/>

    <div class="row row-2">
      <div>
        <label>Your Role *</label>
        <select id="you_are" required>
          <option value="">Selectâ€¦</option>
          <option value="HUSBAND">Husband (Plaintiff)</option>
          <option value="WIFE">Wife (Plaintiff)</option>
        </select>
      </div>
      <div>
        <label>Your Full Name *</label>
        <div class="row row-2">
          <input id="pl_first" required placeholder="First"/>
          <input id="pl_last" required placeholder="Last"/>
        </div>
      </div>
    </div>

    <label>Your Current Full Address *</label>
    <textarea id="pl_addr" required placeholder="Street, City, State ZIP"></textarea>

    <div class="row row-2">
      <div>
        <label>Your Date of Birth *</label>
        <input id="pl_dob" type="date" required/>
      </div>
      <div>
        <label>Phone *</label>
        <input id="phone" required placeholder="(___) ___-____"/>
      </div>
    </div>

    <h3>Spouse</h3>
    <div class="row row-2">
      <div>
        <label>Spouse Full Name *</label>
        <div class="row row-2">
          <input id="def_first" required placeholder="First"/>
          <input id="def_last" required placeholder="Last"/>
        </div>
      </div>
      <div>
        <label>Spouse DOB *</label>
        <input id="def_dob" type="date" required/>
      </div>
    </div>

    <label>Spouse Address *</label>
    <textarea id="def_addr" required placeholder="Street, City, State ZIP"></textarea>

    <h3>Venue &amp; Marriage</h3>
    <div class="row row-2">
      <div>
        <label>Filing County *</label>
        <select id="county" required></select>
      </div>
      <div>
        <label>Basis of Venue *</label>
        <select id="venue_reason" required>
          <option value="">Selectâ€¦</option>
          <option value="PLAINTIFF_LIVES">Plaintiff lives in filing county</option>
          <option value="DEFENDANT_LIVES">Defendant lives in filing county</option>
        </select>
      </div>
    </div>

    <div class="row row-2">
      <div>
        <label>Marriage Country *</label>
        <select id="m_country_sel" required>
          <option value="">Selectâ€¦</option>
          <option value="USA">USA</option>
          <option value="INTL">Outside of the United States</option>
        </select>
      </div>
      <div>
        <label>Marriage Date *</label>
        <input id="m_date" type="date" required/>
      </div>
    </div>

    <div class="row row-2">
      <div>
        <label id="m_city_label">Marriage City *</label>
        <input id="m_city" required/>
      </div>
      <div>
        <label id="m_state_label">Marriage State *</label>
        <input id="m_state_or_country" required placeholder="NY (or country if outside USA)"/>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Wifeâ€™s Maiden Name *</label>
        <input id="wife_maiden" placeholder="If unchanged, re-enter current last name"/>
      </div>
    </div>

    <div style="margin-top:12px">
      <button class="btn" id="build">Generate Free Summons &amp; Complaint</button>
      <span id="status" class="note"></span>
    </div>
  </form>

  <div id="freeBlock" class="card hidden">
    <h3 class="ok">Your Summons &amp; Complaint is ready âœ…</h3>
    <p class="note">This document is based on your answers and ready to file for a New York uncontested divorce with no children.</p>
    <button class="btn alt" id="downloadSAndC">Download Summons &amp; Complaint (.docx)</button>
  </div>

  <div id="fullPackage" class="card hidden">
    <h3>Full Package (Test Mode: Free)</h3>
    <p class="note">All downloads are enabled for testing. In production, these unlock after payment.</p>
    <div style="display:grid;gap:10px">
      <button class="btn" data-doc="AFF_P">Affirmation of Plaintiff</button>
      <button class="btn" data-doc="AFF_D">Affirmation of Defendant</button>
      <button class="btn" data-doc="REG">Affirmation of Regularity</button>
      <button class="btn" data-doc="FIND">Findings &amp; Conclusions</button>
      <button class="btn" data-doc="JUDG">Proposed Judgment</button>
      <button class="btn" data-doc="NOI">Note of Issue</button>
      <button class="btn" data-doc="CERT">Certification</button>
      <button class="btn" data-doc="RJI">RJI (PDF)</button>
      <button class="btn" data-doc="CERTDISS">Certificate of Dissolution (PDF)</button>
      <button class="btn" data-doc="INSTR">Step-by-Step Instructions</button>
    </div>

    <!-- Optional dev helper: drop in any DOCX/PDF to replace a template on the fly -->
    <div class="dev" style="margin-top:10px">
      <strong>Developer test helper:</strong> Upload a DOCX/PDF to set/override a template now (no rebuild).
      <div class="row row-2" style="margin-top:8px">
        <select id="dev_key">
          <option value="COMPLAINT">COMPLAINT</option>
          <option value="AFF_P">AFF_P</option>
          <option value="AFF_D">AFF_D</option>
          <option value="REG">REG</option>
          <option value="FIND">FIND</option>
          <option value="JUDG">JUDG</option>
          <option value="NOI">NOI</option>
          <option value="CERT">CERT</option>
          <option value="INSTR">INSTR</option>
          <option value="RJI">RJI (PDF)</option>
          <option value="CERTDISS">CERTDISS (PDF)</option>
        </select>
        <input id="dev_file" type="file" accept=".docx,.pdf"/>
      </div>
    </div>
  </div>

  <div class="card note">
    Disclaimer: We prepare documents from your answers; you are responsible for signing and filing unless you choose the attorney-handled option.
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
/* ===== MODE ===== */
const FREE_MODE = true; // <<<< All downloads unlocked; PayPal bypassed for testing

/* ===== BACKEND (already your credentials) ===== */
const APPS_SCRIPT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxYcXRcA2G5QmacxUA1AsihyNxB386ZLIQlL7xC8BIN0728hNQ1WRtB3ihFhqwIWJSA/exec";
const DRIVE_FOLDER_ID = "109VOF-SMMZuKTNkzfFoLVG-KUo6vgu3m";
const NOTIFY_EMAIL = "ettrickc@gmail.com";

/* ===== Embedded base64 templates =====
   For PRODUCTION, paste base64 strings for each key below.
   For TESTING, you can use the Dev Helper uploader to set them temporarily.
*/
const TEMPLATES = {
  COMPLAINT: "__B64_COMPLAINT__",  // paste base64 of COMPLAINT.docx here for one-click test
  AFF_P:     "__B64_AFFIRMATION_P__",
  AFF_D:     "__B64_AFFIRMATION_D__",
  REG:       "__B64_REGULARITY__",
  FIND:      "__B64_FINDINGS__",
  JUDG:      "__B64_JUDGMENT__",
  NOI:       "__B64_NOTE_OF_ISSUE__",
  CERT:      "__B64_CERTIFICATION__",
  INSTR:     "__B64_INSTRUCTIONS__",
  RJI:       "__B64_RJI_PDF__",
  CERTDISS:  "__B64_CERT_OF_DISS_PDF__"
};

/* ===== counties (boroughs first) ===== */
const BOROUGH_FIRST = ["Bronx","Kings","New York","Queens","Richmond"];
const OTHER_COUNTIES = ["Albany","Allegany","Broome","Cattaraugus","Cayuga","Chautauqua","Chemung","Chenango","Clinton","Columbia","Cortland","Delaware","Dutchess","Erie","Essex","Franklin","Fulton","Genesee","Greene","Hamilton","Herkimer","Jefferson","Lewis","Livingston","Madison","Monroe","Montgomery","Nassau","Niagara","Oneida","Onondaga","Ontario","Orange","Orleans","Oswego","Otsego","Putnam","Rensselaer","Rockland","St. Lawrence","Saratoga","Schenectady","Schoharie","Schuyler","Seneca","Steuben","Suffolk","Sullivan","Tioga","Tompkins","Ulster","Warren","Washington","Wayne","Westchester","Wyoming","Yates"];
const NY_COUNTIES = [...BOROUGH_FIRST, ...OTHER_COUNTIES];

/* ===== helpers ===== */
const $=s=>document.querySelector(s);
function setChoices(el,arr){ el.innerHTML = '<option value="">Selectâ€¦</option>' + arr.map(x=>`<option>${x}</option>`).join(''); }
function fmtLong(d){ if(!d) return ""; const [y,m,da]=d.split("-").map(n=>parseInt(n,10)); const dt=new Date(y,m-1,da); return dt.toLocaleString('en-US',{month:'long',day:'numeric',year:'numeric'}); }
function b64ToBlob(b64, mime){ const bytes = atob(b64); const arr = new Uint8Array(bytes.length); for(let i=0;i<bytes.length;i++)arr[i]=bytes.charCodeAt(i); return new Blob([arr],{type:mime}); }

async function applyToDocxBase(base64, map){
  const zip = await JSZip.loadAsync(base64, {base64:true});
  const parts = ['word/document.xml','word/header1.xml','word/footer1.xml'];
  for(const p of parts){
    const f=zip.file(p); if(!f) continue;
    let xml=await f.async('string');
    map.forEach((v,k)=>{ xml = xml.replace(k, v); });
    zip.file(p, xml);
  }
  const blob=await zip.generateAsync({type:'blob',mimeType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
  return new Blob([blob],{type:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
}

/* ===== mapping logic to your DOCX placeholders =====
   Your template uses tokens like:
   [KINGS], [JANE DOE], [JOHN DOE], CADDRESS, LADDRESS, [PHONE], VENUED, GMARRIAGEDATE,
   HTOWNCITY, ISTATECOUNTRY, DBIRTH, KBIRTH,
   [1 MAIN STREET, BROOKLYN, NEW YORK 11208], [2 CENTRAL AVENUE, QUEENS, NEW YORK 11422],
   PLAINTIFFMAIDEN, DEFENDANTMAIDEN.
*/
function buildMap(a){
  const county=a.county||"", phone=a.phone||"";
  const venued = a.venue_reason==="PLAINTIFF_LIVES" ? "Plaintiff's" : "Defendantâ€™s";
  const gm = fmtLong(a.m_date);

  // Produce Plaintiff/Defendant names (first + last)
  const pl_name = (a.pl_first + " " + a.pl_last).trim();
  const def_name = (a.def_first + " " + a.def_last).trim();

  // Decide which tag gets the wife's maiden name
  // If Plaintiff is Wife => PLAINTIFFMAIDEN = wife's maiden; else DEFENDANTMAIDEN = wife's maiden
  const maiden = (a.wife_maiden || "").toUpperCase();
  const setPlaintiffMaiden = a.role === "WIFE";

  const map = new Map();
  map.set(/\[KINGS\]/g, county);
  map.set(/\[JANE\s+DOE\]/g, pl_name);
  map.set(/\[JOHN\s+DOE\]/g, def_name);

  map.set(/CADDRESS/g, a.pl_addr||"");
  map.set(/LADDRESS/g, a.def_addr||"");
  map.set(/\[PHONE\]/g, phone);
  map.set(/VENUED/g, venued);
  map.set(/GMARRIAGEDATE/g, gm||"");

  // Marriage place (USA vs INTL)
  const town = a.m_city || "";
  const stateOrCountry = a.m_state_or_country || "";
  map.set(/HTOWNCITY/g, town.toUpperCase());
  map.set(/ISTATECOUNTRY/g, stateOrCountry.toUpperCase());

  map.set(/DBIRTH/g, fmtLong(a.pl_dob)||"");
  map.set(/KBIRTH/g, fmtLong(a.def_dob)||"");

  // Known literal examples (safe to overwrite)
  map.set(/\[1 MAIN STREET, BROOKLYN, NEW YORK 11208\]/g, a.pl_addr||"");
  map.set(/\[2 CENTRAL AVENUE, QUEENS, NEW YORK 11422\]/g, a.def_addr||"");

  // Maiden tags
  if (setPlaintiffMaiden) {
    map.set(/PLAINTIFFMAIDEN/g, maiden);
    map.set(/DEFENDANTMAIDEN/g, "");
  } else {
    map.set(/DEFENDANTMAIDEN/g, maiden);
    map.set(/PLAINTIFFMAIDEN/g, "");
  }

  return map;
}

function collect(){
  const isUSA = $('#m_country_sel').value === 'USA';
  return {
    role: $('#you_are').value,
    pl_first: $('#pl_first').value.trim(),
    pl_last:  $('#pl_last').value.trim(),
    pl_addr: $('#pl_addr').value.trim(),
    pl_dob: $('#pl_dob').value,
    phone: $('#phone').value.trim(),
    email: $('#email').value.trim(),
    def_first: $('#def_first').value.trim(),
    def_last:  $('#def_last').value.trim(),
    def_dob: $('#def_dob').value,
    def_addr: $('#def_addr').value.trim(),
    county: $('#county').value,
    venue_reason: $('#venue_reason').value,
    m_date: $('#m_date').value,
    m_country_sel: $('#m_country_sel').value,
    m_city: $('#m_city').value.trim(),
    m_state_or_country: $('#m_state_or_country').value.trim(),
    wife_maiden: $('#wife_maiden').value.trim(),
    marriage_is_usa: isUSA
  };
}

async function sendToAppsScript(payload){
  try{
    await fetch(APPS_SCRIPT_WEBAPP_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        type:"divorce-intake",
        notifyEmail: NOTIFY_EMAIL,
        driveFolderId: DRIVE_FOLDER_ID,
        payload
      })
    });
  }catch(e){ console.warn("Apps Script error (non-blocking):", e); }
}

/* ===== page init ===== */
let lastComplaintBlob = null;

document.addEventListener('DOMContentLoaded', () => {
  // Counties: boroughs first
  setChoices($('#county'), NY_COUNTIES);

  // Marriage labels based on country
  function updateMarriageLabels() {
    const isUSA = $('#m_country_sel').value === 'USA';
    $('#m_city_label').textContent = isUSA ? 'Marriage City *' : 'Marriage Town *';
    $('#m_state_label').textContent = isUSA ? 'Marriage State *' : 'Marriage Country *';
    $('#m_state_or_country').placeholder = isUSA ? 'NY' : 'Country (e.g., Jamaica)';
  }
  $('#m_country_sel').addEventListener('change', updateMarriageLabels);
  updateMarriageLabels();

  // Build free S&C
  $('#build').addEventListener('click', async (e)=>{
    e.preventDefault();
    $('#status').textContent = "Building your Summons & Complaintâ€¦";
    try{
      const data = collect();
      if(!(TEMPLATES.COMPLAINT||"").trim()){ throw new Error("Complaint template not embedded yet. Use Dev Helper to upload a DOCX temporarily."); }
      const map = buildMap(data);
      lastComplaintBlob = await applyToDocxBase(TEMPLATES.COMPLAINT, map);
      $('#status').textContent = "Ready!";
      $('#freeBlock').classList.remove('hidden');
      if (FREE_MODE) $('#fullPackage').classList.remove('hidden');

      // Email + save to Drive via Apps Script (non-blocking)
      const reader = new FileReader();
      reader.onload = () => {
        const b64 = reader.result.split(",")[1];
        sendToAppsScript({...data, complaint_b64: b64, paidTier: FREE_MODE ? "FREE_TEST" : "FREE"});
      };
      reader.readAsDataURL(lastComplaintBlob);
    }catch(err){
      console.error(err);
      $('#status').textContent = "Error. Please try again.";
    }
  });

  // Download S&C
  $('#downloadSAndC').addEventListener('click', ()=>{
    if(!lastComplaintBlob) return;
    saveAs(lastComplaintBlob, "NY_Summons_and_Complaint.docx");
  });

  // Full package (test mode: let user download if base64 present)
  document.querySelectorAll('#fullPackage [data-doc]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.getAttribute('data-doc');
      const b64 = (TEMPLATES[key]||"").trim();
      if(!b64){ alert("This template is not embedded yet. (OK in test mode)"); return; }
      const isPdf = (key==="RJI" || key==="CERTDISS");
      const blob = b64ToBlob(b64, isPdf ? "application/pdf" : "application/vnd.openxmlformats-officedocument.wordprocessingml.document");
      saveAs(blob, `NY_${key}.${isPdf?'pdf':'docx'}`);
    });
  });

  // Dev helper: drop a file to set a template immediately (for quick testing)
  $('#dev_file').addEventListener('change', ()=>{
    const file = $('#dev_file').files[0];
    if(!file) return;
    const key = $('#dev_key').value;
    const reader = new FileReader();
    reader.onload = () => {
      const b64 = reader.result.split(",")[1];
      TEMPLATES[key] = b64;
      alert(`Template "${key}" loaded for this session.`);
    };
    reader.readAsDataURL(file);
  });
});
</script>
</body>
</html>
