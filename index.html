<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NY Uncontested Divorce ‚Äî Test Mode (All Downloads Free)</title>
<meta name="description" content="Instant NY Summons & Complaint and full divorce packet in test mode (no payment)."/>

<style>
:root{
  --primary:#0d6efd;
  --primary-dark:#0b5ed7;
  --success:#198754;
  --danger:#b91c1c;
  --line:#e5e7eb;
  --bg:#f9fafb;
  --ink:#111827;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  background:#ffffff;
  color:var(--ink);
  font-size:16px;
}
.wrap{
  max-width:960px;
  margin:24px auto;
  padding:0 16px 40px;
}
h1{
  margin:0 0 6px;
  font-size:2rem;
  font-weight:700;
}
h3{
  margin:0 0 8px;
  font-size:1.35rem;
  font-weight:600;
}
.card{
  border:1px solid var(--line);
  background:#fff;
  border-radius:12px;
  padding:18px 16px 20px;
  margin:16px 0;
  box-shadow:0 4px 10px rgba(0,0,0,.04);
}
.chips{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin:8px 0 4px;
}
.chip{
  border-radius:999px;
  border:1px solid var(--line);
  padding:6px 10px;
  font-size:.9rem;
  background:#fff;
}
label{
  display:block;
  margin:10px 0 4px;
  font-weight:600;
  font-size:.98rem;
}
input,select,textarea{
  width:100%;
  padding:10px 11px;
  border-radius:8px;
  border:1px solid var(--line);
  background:#f9fafb;
  font-size:1rem;
}
input:focus,select:focus,textarea:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 2px rgba(13,110,253,.15);
  background:#fff;
}
textarea{min-height:80px;resize:vertical;}
.grid{display:grid;gap:12px;}
@media(min-width:760px){.grid-2{grid-template-columns:1fr 1fr;}}
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:.5rem;
  padding:12px 18px;
  border-radius:10px;
  border:0;
  cursor:pointer;
  font-weight:700;
  font-size:1rem;
  text-decoration:none;
}
.btn-primary{
  background:var(--primary);
  color:#fff;
  box-shadow:0 4px 10px rgba(13,110,253,.3);
}
.btn-primary:hover{background:var(--primary-dark);}
.btn-success{
  background:var(--success);
  color:#fff;
}
.btn-success:hover{background:#146c43;}
.btn-secondary{
  background:#e5e7eb;
  color:#111827;
}
.small{font-size:.9rem;color:#4b5563;}
.error{color:var(--danger);font-weight:600;margin-top:4px;display:none;}
.hidden{display:none !important;}
.notice{
  background:#eff6ff;
  border:1px solid #bfdbfe;
  border-radius:10px;
  padding:10px 12px;
  font-size:.9rem;
}
.badge-bar{
  height:4px;
  border-radius:999px;
  background:linear-gradient(90deg,var(--primary-dark),var(--success));
  margin-top:8px;
}
.download-group{margin-top:16px;}
.download-grid{display:grid;gap:10px;}
@media(min-width:720px){.download-grid{grid-template-columns:1fr 1fr;}}
.toast{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:18px;
  background:#111827;
  color:#fff;
  padding:8px 12px;
  border-radius:8px;
  font-size:.9rem;
  display:none;
  z-index:9999;
}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>NY Uncontested Divorce (No Children)</h1>
    <div class="chips">
      <span class="chip">‚úÖ Court-Ready Formatting</span>
      <span class="chip">üì• Instant Download</span>
      <span class="chip">üìß Copy Saved for Your Records</span>
    </div>
    <p class="small">
      Fill this out once. We‚Äôll build your <strong>Summons &amp; Complaint</strong> and your full packet (Affirmations, Findings, Judgment, Note of Issue, etc.).
      <br><strong>Test mode:</strong> all downloads are free right now (no payment) so you can confirm everything works before you charge clients.
    </p>
    <div class="notice">
      <strong>Quick requirements:</strong> No children of the marriage, spouse will sign consent forms, and either you or your spouse lives in New York.
    </div>
    <div class="badge-bar"></div>
  </div>

  <!-- STEP 1: Contact & Requirements -->
  <div class="card">
    <h3>1. Contact & Requirements</h3>
    <div class="grid grid-2">
      <div>
        <label>Email (for receipts &amp; document delivery) *</label>
        <input id="email" type="email" placeholder="you@example.com">
      </div>
      <div>
        <label>Phone (required for court forms) *</label>
        <input id="phone" placeholder="(___) ___-____">
      </div>
    </div>
    <label style="margin-top:10px;">
      <input id="ack" type="checkbox" style="width:auto;margin-right:6px;transform:translateY(1px);">
      I confirm this is a New York uncontested divorce with no children, and my spouse will sign.
    </label>
    <div id="err-step1" class="error">Please enter your email, phone, and confirm the checkbox.</div>
  </div>

  <!-- STEP 2: Plaintiff, Venue, Marriage -->
  <div class="card">
    <h3>2. Plaintiff, Venue &amp; Marriage Details</h3>
    <div class="grid grid-2">
      <div>
        <label>Your Role *</label>
        <select id="you_are">
          <option value="">Select‚Ä¶</option>
          <option value="HUSBAND">Husband (Plaintiff)</option>
          <option value="WIFE">Wife (Plaintiff)</option>
        </select>
      </div>
      <div>
        <label>Your Full Name (Plaintiff) *</label>
        <div class="grid grid-2">
          <input id="pl_first" placeholder="First">
          <input id="pl_last" placeholder="Last">
        </div>
      </div>
    </div>

    <label>Your Current Full Address *</label>
    <textarea id="pl_addr" placeholder="Street, City, State ZIP"></textarea>

    <div class="grid grid-2">
      <div>
        <label>Your Date of Birth *</label>
        <input id="pl_dob" type="date">
      </div>
      <div>
        <label>Filing County (New York) *</label>
        <select id="county"></select>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label id="venue_label">Filing Residency Reason (who lives in this county?) *</label>
      <select id="venue_reason" disabled>
        <option value="">Select‚Ä¶</option>
        <option value="PLAINTIFF_LIVES">Because I live in this county</option>
        <option value="DEFENDANT_LIVES">Because my spouse lives in this county</option>
      </select>
      <div class="small">
        This controls whether the Complaint‚Äôs SECOND paragraph says ‚ÄúPlaintiff‚Äù or ‚ÄúDefendant‚Äù as the New York resident.
      </div>
    </div>

    <div class="grid grid-2" style="margin-top:10px;">
      <div>
        <label>Marriage Location *</label>
        <select id="m_where">
          <option value="">Select‚Ä¶</option>
          <option value="US">United States</option>
          <option value="INTL">Outside the U.S.</option>
        </select>
      </div>
      <div>
        <label>Marriage Date *</label>
        <input id="m_date" type="date">
      </div>
    </div>

    <!-- Dynamic US vs International pair -->
    <div id="us_pair" class="grid grid-2" style="margin-top:10px;">
      <div>
        <label>Marriage City *</label>
        <input id="m_city" placeholder="e.g., Brooklyn">
      </div>
      <div>
        <label>Marriage State *</label>
        <select id="m_state"></select>
      </div>
    </div>

    <div id="intl_pair" class="grid grid-2 hidden" style="margin-top:10px;">
      <div>
        <label>Marriage Town *</label>
        <input id="m_town" placeholder="e.g., Montego Bay">
      </div>
      <div>
        <label>Marriage Country *</label>
        <input id="m_country" placeholder="e.g., Jamaica">
      </div>
    </div>

    <!-- Prior/Maiden surname logic -->
    <div class="card" style="margin-top:14px;background:#f9fafb;border-style:dashed;">
      <label>Prior / Maiden Surname (if anyone will resume a former name)</label>
      <div class="small" style="margin-bottom:6px;">
        Select who has a prior/maiden surname that should appear in the documents (for the legal name-resumption paragraph).
      </div>
      <div class="grid grid-2">
        <label class="small"><input type="radio" name="prior_who" value="NONE" checked style="width:auto;margin-right:6px;"> No prior surnames</label>
        <label class="small"><input type="radio" name="prior_who" value="YOU"  style="width:auto;margin-right:6px;"> I do (Plaintiff)</label>
        <label class="small"><input type="radio" name="prior_who" value="SPOUSE" style="width:auto;margin-right:6px;"> My spouse does</label>
        <label class="small"><input type="radio" name="prior_who" value="BOTH" style="width:auto;margin-right:6px;"> Both of us</label>
      </div>

      <div id="you_prior_wrap" class="hidden" style="margin-top:8px;">
        <label>Your prior / maiden surname</label>
        <input id="pl_prior" placeholder="Enter your prior surname">
      </div>
      <div id="spouse_prior_wrap" class="hidden" style="margin-top:8px;">
        <label>Spouse prior / maiden surname</label>
        <input id="sp_prior" placeholder="Enter spouse prior surname">
      </div>
    </div>

    <div id="err-step2" class="error">Please complete all required fields in this section.</div>
  </div>

  <!-- STEP 3: Spouse & SSN -->
  <div class="card">
    <h3>3. Spouse &amp; SSN Details</h3>

    <div class="grid grid-2">
      <div>
        <label>Spouse Full Name (Defendant) *</label>
        <div class="grid grid-2">
          <input id="def_first" placeholder="First">
          <input id="def_last" placeholder="Last">
        </div>
      </div>
      <div>
        <label>Spouse Date of Birth *</label>
        <input id="def_dob" type="date">
      </div>
    </div>

    <label>Spouse Current Full Address *</label>
    <textarea id="def_addr" placeholder="Street, City, State ZIP"></textarea>

    <div class="grid grid-2" style="margin-top:10px;">
      <div>
        <label>Your SSN (last 4 ‚Äî enter ‚Äúnone‚Äù if you don‚Äôt have one)</label>
        <input id="pl_ssn" maxlength="4" placeholder="1234 or none">
      </div>
      <div>
        <label>Spouse SSN (last 4 ‚Äî enter ‚Äúnone‚Äù if no SSN)</label>
        <input id="def_ssn" maxlength="4" placeholder="1234 or none">
      </div>
    </div>

    <div class="small" style="margin-top:6px;">
      These go into the court line that looks like <code>XXX-XX-____</code> for each party. If you type ‚Äúnone,‚Äù the line will stay blank.
    </div>

    <div id="err-step3" class="error">Please complete the required spouse fields.</div>

    <div style="margin-top:16px;">
      <button id="build" class="btn btn-primary" style="width:100%;">4. Generate All Divorce Documents</button>
      <div id="status" class="small" style="margin-top:6px;"></div>
    </div>
  </div>

  <!-- Downloads -->
  <div id="downloadsCard" class="card hidden">
    <h3>5. Download Your Documents</h3>
    <p class="small">
      First download the <strong>Summons &amp; Complaint</strong> to start the case.
      Then download the rest of the forms to finish your uncontested divorce.
    </p>
    <div class="download-group">
      <button class="btn btn-success" id="downloadSAndC" style="width:100%;margin-bottom:10px;">
        ‚¨á Download Summons &amp; Complaint (File to Start Case)
      </button>
    </div>
    <div class="download-group">
      <h4 style="margin:8px 0 6px;font-size:1.05rem;">Full Packet (All Remaining Forms)</h4>
      <div class="download-grid">
        <button class="btn btn-secondary" data-doc="AFF_P">Affirmation of Plaintiff</button>
        <button class="btn btn-secondary" data-doc="AFF_D">Affirmation of Defendant</button>
        <button class="btn btn-secondary" data-doc="REG">Affirmation of Regularity</button>
        <button class="btn btn-secondary" data-doc="FIND">Findings &amp; Conclusions</button>
        <button class="btn btn-secondary" data-doc="JUDG">Proposed Judgment</button>
        <button class="btn btn-secondary" data-doc="NOI">Note of Issue</button>
        <button class="btn btn-secondary" data-doc="CERT">Certification</button>
        <button class="btn btn-secondary" data-doc="RJI">RJI (PDF)</button>
        <button class="btn btn-secondary" data-doc="CERTDISS">Certificate of Dissolution (PDF)</button>
        <button class="btn btn-secondary" data-doc="INSTR">Instructions (Step-by-Step)</button>
      </div>
      <button class="btn btn-success" id="downloadAll" style="margin-top:12px;width:100%;">‚¨á Download All Forms Together</button>
    </div>
  </div>

  <div class="card small">
    Disclaimer: This is a document preparation tool. It is designed to help you generate documents based on your answers. You remain responsible for signing, filing, and following the instructions for your county.
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- JSZip + FileSaver for DOCX/PDF building -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
/* ========= 1. EMBEDDED TEMPLATES (BASE64 PLACEHOLDERS) ========= */
/* Later, we‚Äôll replace each __B64_...__ with the actual base64 strings */
const EMBEDDED_TEMPLATES = {
  COMPLAINT: "__B64_COMPLAINT__",
  AFF_P:     "__B64_AFF_P__",
  AFF_D:     "__B64_AFF_D__",
  REG:       "__B64_REG__",
  FIND:      "__B64_FIND__",
  JUDG:      "__B64_JUDG__",
  NOI:       "__B64_NOI__",
  CERT:      "__B64_CERT__",
  INSTR:     "__B64_INSTR__",
  RJI:       "__B64_RJI_PDF__",
  CERTDISS:  "__B64_CERTDISS_PDF__"
};
/* =============================================================== */

const $ = id => document.getElementById(id);

/* Small toast helper */
function toast(msg, ok){
  const t = $("toast");
  t.textContent = msg;
  t.style.background = ok ? "#14532d" : "#111827";
  t.style.display = "block";
  setTimeout(()=>{ t.style.display="none"; }, 2800);
}

/* Populate dropdowns */
const NY_COUNTIES = [
  "Albany","Allegany","Bronx","Broome","Cattaraugus","Cayuga","Chautauqua","Chemung",
  "Chenango","Clinton","Columbia","Cortland","Delaware","Dutchess","Erie","Essex",
  "Franklin","Fulton","Genesee","Greene","Hamilton","Herkimer","Jefferson","Kings",
  "Lewis","Livingston","Madison","Monroe","Montgomery","Nassau","New York","Niagara",
  "Oneida","Onondaga","Ontario","Orange","Orleans","Oswego","Otsego","Putnam","Queens",
  "Rensselaer","Richmond","Rockland","St. Lawrence","Saratoga","Schenectady","Schoharie",
  "Schuyler","Seneca","Steuben","Suffolk","Sullivan","Tioga","Tompkins","Ulster","Warren",
  "Washington","Wayne","Westchester","Wyoming","Yates"
];
const US_STATES = [
  "Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware",
  "District of Columbia","Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas",
  "Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi",
  "Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York",
  "North Carolina","North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island",
  "South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virginia","Washington",
  "West Virginia","Wisconsin","Wyoming"
];

function fillSelect(el, arr, placeholder){
  el.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = placeholder;
  el.appendChild(opt0);
  arr.forEach(v=>{
    const o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    el.appendChild(o);
  });
}

/* Utility: date -> "Month d, yyyy" */
function formatDateLong(val){
  if(!val) return "";
  const parts = val.split("-");
  if(parts.length!==3) return val;
  const y = parseInt(parts[0],10),
        m = parseInt(parts[1],10),
        d = parseInt(parts[2],10);
  if(!y||!m||!d) return val;
  const dt = new Date(y,m-1,d);
  const month = dt.toLocaleString("en-US",{month:"long"});
  return `${month} ${d}, ${y}`;
}

/* XML helpers */
function xmlEscape(str){
  return String(str||"").replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");
}
function normalizeXmlRuns(xml){
  return xml.replace(/<\/w:t>\s*<\/w:r>\s*<w:r[^>]*>\s*<w:t[^>]*>/g,"");
}

/* Build the replacement map for all templates */
function buildReplacementMap(payload){
  const map = new Map();

  const pl_name  = (payload.pl_first + " " + payload.pl_last).trim();
  const def_name = (payload.def_first + " " + payload.def_last).trim();

  const county   = xmlEscape(payload.county);
  const pl_addr  = xmlEscape(payload.pl_addr);
  const def_addr = xmlEscape(payload.def_addr);
  const phone    = xmlEscape(payload.phone);

  const gmLong   = formatDateLong(payload.m_date);
  const plDob    = formatDateLong(payload.pl_dob);
  const defDob   = formatDateLong(payload.def_dob);

  // Venue: Plaintiff vs Defendant lives in county
  const venued = (payload.venue_reason === "PLAINTIFF_LIVES") ? "PLAINTIFF" : "DEFENDANT";

  // Basic name/address placeholders
  map.set(/\[KINGS\]/gi, county);
  map.set(/\[JANE\s+DOE\]/gi, xmlEscape(pl_name));
  map.set(/\[JOHN\s+DOE\]/gi, xmlEscape(def_name));

  // ‚úÖ Note of Issue line: "Defendant:  Office and P.O. Address:"
  map.set(/Defendant:\s+Office and P\.O\. Address:/g, `Defendant: ${xmlEscape(def_name)} Office and P.O. Address:`);

  // Venue-related sentences + SECOND paragraph [Plaintiff] logic
  if(payload.venue_reason === "PLAINTIFF_LIVES"){
    map.set(/The basis of venue is \[Plaintiff's\] residence\./g, "The basis of venue is Plaintiff's residence.");
    map.set(/Plaintiff resides at \[1 MAIN STREET, BROOKLYN, NEW YORK 11208\]\./g, `Plaintiff resides at ${pl_addr}.`);
    map.set(/The \[Plaintiff\] has resided in New York State for a continuous period in excess of two years immediately preceding the commencement of this action\./g,
      "The Plaintiff has resided in New York State for a continuous period in excess of two years immediately preceding the commencement of this action.");
    // SECOND paragraph: [Plaintiff] ‚Üí Plaintiff (no brackets)
    map.set(/\[Plaintiff\]/g, "Plaintiff");
  } else {
    map.set(/The basis of venue is \[Plaintiff's\] residence\./g, "The basis of venue is Defendant‚Äôs residence.");
    map.set(/Plaintiff resides at \[1 MAIN STREET, BROOKLYN, NEW YORK 11208\]\./g, `Defendant resides at ${def_addr}.`);
    map.set(/The \[Plaintiff\] has resided in New York State for a continuous period in excess of two years immediately preceding the commencement of this action\./g,
      "The Defendant has resided in New York State for a continuous period in excess of two years immediately preceding the commencement of this action.");
    // SECOND paragraph: [Plaintiff] ‚Üí Defendant (no brackets)
    map.set(/\[Plaintiff\]/g, "Defendant");
  }

  // Addresses in other sample lines
  map.set(/\[1 MAIN STREET BROOKLYN, NEW YORK 11208\]/g, pl_addr);
  map.set(/\[2 CENTRAL AVENUE, QUEENS, NEW YORK 11422\]/g, def_addr);

  // Marriage date placeholders
  if(gmLong){
    map.set(/\[April 22, 2020\]/g, gmLong);
    map.set(/GMARRIAGEDATE/g, gmLong);
    map.set(/G[\u00A0\u200B\u200C\u200D\uFEFF\s]*MARRIAGEDATE/gi, gmLong);
  } else {
    map.set(/GMARRIAGEDATE/g, "");
    map.set(/G[\u00A0\u200B\u200C\u200D\uFEFF\s]*MARRIAGEDATE/gi, "");
  }

  // Marriage city/town + state/country
  const townCity = (payload.m_where === "US") ? (payload.m_city || "") : (payload.m_town || "");
  const stateCountry = (payload.m_where === "US") ? (payload.m_state || "") : (payload.m_country || "");
  map.set(/HTOWNCITY/g, xmlEscape(townCity));
  map.set(/ISTATECOUNTRY/g, xmlEscape(stateCountry));

  // Special line: "COUNTY OF [QUEENS] AND STATE OF [NEW YORK]."
  if(payload.m_where === "US"){
    if(payload.m_city){
      map.set(/COUNTY OF \[QUEENS\] AND STATE OF \[NEW YORK\]\./g,
        `COUNTY OF ${xmlEscape(payload.m_city).toUpperCase()} AND STATE OF NEW YORK.`);
    }
  } else {
    map.set(/COUNTY OF \[QUEENS\] AND STATE OF \[NEW YORK\]\./g,
      `TOWN OF ${xmlEscape(payload.m_town).toUpperCase()} AND COUNTRY OF ${xmlEscape(payload.m_country).toUpperCase()}.`);
  }

  // Phone
  if(phone) map.set(/\[PHONE\]/g, phone);

  // SSN last 4: we assume templates use MSOCIAL for Plaintiff and NSOCIAL for Defendant
  const plSSNraw  = (payload.pl_ssn || "").trim();
  const defSSNraw = (payload.def_ssn || "").trim();
  const plSSN  = (plSSNraw.toLowerCase()==="none")  ? "" : plSSNraw;
  const defSSN = (defSSNraw.toLowerCase()==="none") ? "" : defSSNraw;
  map.set(/MSOCIAL/g, xmlEscape(plSSN));
  map.set(/NSOCIAL/g, xmlEscape(defSSN));

  // Birthdates
  if(plDob)  map.set(/DBIRTH/g, xmlEscape(plDob));
  if(defDob) map.set(/KBIRTH/g, xmlEscape(defDob));

  // VENUED token
  map.set(/\[?VENUED\]?/g, venued);

  // Maiden / prior surnames
  const priorWho = payload.priorWho || "NONE";
  let plMaiden = "NOT APPLICABLE";
  let defMaiden = "NOT APPLICABLE";
  if((priorWho==="YOU" || priorWho==="BOTH") && payload.pl_prior){
    plMaiden = payload.pl_prior;
  }
  if((priorWho==="SPOUSE" || priorWho==="BOTH") && payload.sp_prior){
    defMaiden = payload.sp_prior;
  }
  map.set(/PLAINTIFFMAIDEN/g, xmlEscape(plMaiden));
  map.set(/DEFENDANTMAIDEN/g, xmlEscape(defMaiden));

  return map;
}

/* Convert base64 -> blob */
function b64ToBlob(b64, mime){
  const byteChars = atob(b64);
  const byteNums = new Array(byteChars.length);
  for(let i=0;i<byteChars.length;i++){
    byteNums[i] = byteChars.charCodeAt(i);
  }
  const byteArray = new Uint8Array(byteNums);
  return new Blob([byteArray], {type:mime});
}

/* Apply replacements to DOCX via JSZip */
async function applyToDocxBase(base64, map){
  if(!window.JSZip) throw new Error("JSZip not loaded");
  const zip = await JSZip.loadAsync(base64, {base64:true});
  const targets = [
    "word/document.xml",
    "word/header1.xml","word/header2.xml","word/header3.xml",
    "word/footer1.xml","word/footer2.xml","word/footer3.xml"
  ];
  for(const path of targets){
    const f = zip.file(path);
    if(!f) continue;
    let xml = await f.async("string");
    xml = normalizeXmlRuns(xml);
    map.forEach((val, re)=>{
      xml = xml.replace(re, val);
    });
    zip.file(path, xml);
  }
  const outBlob = await zip.generateAsync({
    type:"blob",
    mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"
  });
  return outBlob;
}

/* Build and download a doc by key */
async function buildAndDownloadDoc(docKey, payload){
  const base64 = (EMBEDDED_TEMPLATES[docKey] || "").trim();
  if(!base64 || base64.startsWith("__B64_")){
    toast(`Template for ${docKey} is not embedded yet.`, false);
    return;
  }

  let blob, filename;
  if(docKey === "RJI" || docKey === "CERTDISS"){
    // PDF: no replacements, just download
    blob = b64ToBlob(base64, "application/pdf");
    filename = `NY_${docKey}.pdf`;
  } else {
    const map = buildReplacementMap(payload);
    const docBlob = await applyToDocxBase(base64, map);
    blob = docBlob;
    filename = `NY_${docKey}.docx`;
  }
  saveAs(blob, filename);
  toast(`Downloading ${filename}`, true);
}

/* Collect all answers from the form */
function collectPayload(){
  const priorRadio = document.querySelector('input[name="prior_who"]:checked');
  return {
    email: $("email").value.trim(),
    phone: $("phone").value.trim(),
    role: $("you_are").value,
    pl_first: $("pl_first").value.trim(),
    pl_last: $("pl_last").value.trim(),
    pl_addr: $("pl_addr").value.trim(),
    pl_dob: $("pl_dob").value,
    county: $("county").value,
    venue_reason: $("venue_reason").value,
    m_where: $("m_where").value,
    m_date: $("m_date").value,
    m_city: $("m_city").value.trim(),
    m_state: $("m_state").value,
    m_town: $("m_town").value.trim(),
    m_country: $("m_country").value.trim(),
    priorWho: priorRadio ? priorRadio.value : "NONE",
    pl_prior: $("pl_prior").value.trim(),
    sp_prior: $("sp_prior").value.trim(),
    def_first: $("def_first").value.trim(),
    def_last: $("def_last").value.trim(),
    def_addr: $("def_addr").value.trim(),
    def_dob: $("def_dob").value,
    pl_ssn: $("pl_ssn").value.trim(),
    def_ssn: $("def_ssn").value.trim()
  };
}

/* Validation helpers */
function validateStep1(){
  let ok = true;
  if(!$("email").value.trim()) ok = false;
  if(!$("phone").value.trim()) ok = false;
  if(!$("ack").checked) ok = false;
  $("err-step1").style.display = ok ? "none" : "block";
  return ok;
}
function validateStep2(){
  let ok = true;
  const must = ["you_are","pl_first","pl_last","pl_addr","pl_dob","county","venue_reason","m_where","m_date"];
  for(const id of must){
    if(!$(id).value.trim()) ok = false;
  }
  if($("m_where").value === "US"){
    if(!$("m_city").value.trim() || !$("m_state").value.trim()) ok = false;
  } else if($("m_where").value === "INTL"){
    if(!$("m_town").value.trim() || !$("m_country").value.trim()) ok = false;
  }
  const r = document.querySelector('input[name="prior_who"]:checked');
  const pw = r ? r.value : "NONE";
  if((pw==="YOU" || pw==="BOTH") && !$("pl_prior").value.trim()) ok = false;
  if((pw==="SPOUSE" || pw==="BOTH") && !$("sp_prior").value.trim()) ok = false;

  $("err-step2").style.display = ok ? "none" : "block";
  return ok;
}
function validateStep3(){
  let ok = true;
  const must = ["def_first","def_last","def_addr","def_dob"];
  for(const id of must){
    if(!$(id).value.trim()) ok = false;
  }
  $("err-step3").style.display = ok ? "none" : "block";
  return ok;
}

/* Dynamic label behaviours */
function onRoleChange(){
  // We keep this simple: just for clarity in future if you want to change spouse label text.
}
function onCountyChange(){
  const sel = $("county");
  const idx = sel.selectedIndex;
  const txt = (idx > 0) ? sel.options[idx].text : "";
  const venueLabel = $("venue_label");
  const venue = $("venue_reason");

  if(txt){
    venueLabel.innerHTML = `Filing Residency Reason in <u>${txt}</u> *`;
    venue.disabled = false;
    if(venue.options[0]) venue.options[0].textContent = txt;
    if(venue.options[1]) venue.options[1].textContent = `Because I live in ${txt}`;
    if(venue.options[2]) venue.options[2].textContent = `Because my spouse lives in ${txt}`;
  } else {
    venueLabel.textContent = "Filing Residency Reason (who lives in this county?) *";
    venue.disabled = true;
    if(venue.options[0]) venue.options[0].textContent = "Select‚Ä¶";
    if(venue.options[1]) venue.options[1].textContent = "Because I live in this county";
    if(venue.options[2]) venue.options[2].textContent = "Because my spouse lives in this county";
  }
}
function onWhereChange(){
  const where = $("m_where").value;
  const usPair = $("us_pair");
  const intlPair = $("intl_pair");
  if(where === "US"){
    usPair.classList.remove("hidden");
    intlPair.classList.add("hidden");
    $("m_city").required = true;
    $("m_state").required = true;
    $("m_town").required = false;
    $("m_country").required = false;
  } else if(where === "INTL"){
    usPair.classList.add("hidden");
    intlPair.classList.remove("hidden");
    $("m_city").required = false;
    $("m_state").required = false;
    $("m_town").required = true;
    $("m_country").required = true;
  } else {
    usPair.classList.add("hidden");
    intlPair.classList.add("hidden");
  }
}
function onPriorRadioChange(){
  const r = document.querySelector('input[name="prior_who"]:checked');
  const v = r ? r.value : "NONE";
  $("you_prior_wrap").classList.toggle("hidden", !(v==="YOU" || v==="BOTH"));
  $("spouse_prior_wrap").classList.toggle("hidden", !(v==="SPOUSE" || v==="BOTH"));
}

/* Download helpers */
async function handleSingleDownload(docKey){
  const payload = collectPayload();
  await buildAndDownloadDoc(docKey, payload);
}
async function handleDownloadAll(){
  const payload = collectPayload();
  const order = ["COMPLAINT","AFF_P","AFF_D","REG","FIND","JUDG","NOI","CERT","RJI","CERTDISS","INSTR"];
  for(const key of order){
    const base64 = (EMBEDDED_TEMPLATES[key] || "").trim();
    if(!base64 || base64.startsWith("__B64_")) continue;
    await buildAndDownloadDoc(key, payload);
    await new Promise(res=>setTimeout(res, 350));
  }
}

/* Init on load */
document.addEventListener("DOMContentLoaded", ()=>{
  // Fill select options
  fillSelect($("county"), NY_COUNTIES, "Select county‚Ä¶");
  fillSelect($("m_state"), US_STATES, "Select state‚Ä¶");

  $("you_are").addEventListener("change", onRoleChange);
  $("county").addEventListener("change", onCountyChange);
  $("m_where").addEventListener("change", onWhereChange);
  document.querySelectorAll('input[name="prior_who"]').forEach(r=>{
    r.addEventListener("change", onPriorRadioChange);
  });

  // Generate button
  $("build").addEventListener("click", async (e)=>{
    e.preventDefault();
    const ok1 = validateStep1();
    const ok2 = validateStep2();
    const ok3 = validateStep3();
    if(!ok1 || !ok2 || !ok3){
      toast("Please fix the highlighted sections above.", false);
      return;
    }
    $("status").textContent = "Building all documents‚Ä¶ please wait.";
    try{
      // Build S&C once so user can download immediately + show downloads section
      const payload = collectPayload();
      // Just test one build to ensure templates exist (optional)
      const base64 = (EMBEDDED_TEMPLATES["COMPLAINT"] || "").trim();
      if(!base64 || base64.startsWith("__B64_")){
        $("status").textContent = "Templates are not embedded yet. We‚Äôll do that step next.";
        toast("Templates not embedded yet ‚Äî structure is ready though.", false);
      } else {
        await buildAndDownloadDoc("COMPLAINT", payload);
        $("status").textContent = "Summons & Complaint downloaded. Scroll down for the full packet.";
        toast("Summons & Complaint ready. Full packet buttons are unlocked below.", true);
      }
      $("downloadsCard").classList.remove("hidden");
      document.getElementById("downloadsCard").scrollIntoView({behavior:"smooth"});
    }catch(err){
      console.error(err);
      $("status").textContent = "There was a technical issue building the document.";
      toast("Error building document. Check console or contact support.", false);
    }
  });

  // S&C button
  $("downloadSAndC").addEventListener("click", async ()=>{
    await handleSingleDownload("COMPLAINT");
  });

  // Individual doc buttons
  document.querySelectorAll('#downloadsCard button[data-doc]').forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const key = btn.getAttribute("data-doc");
      await handleSingleDownload(key);
    });
  });

  // Download all
  $("downloadAll").addEventListener("click", async ()=>{
    await handleDownloadAll();
  });
});
</script>
</body>
</html>

